apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: cluster-remove-pipeline
  namespace: hub-provisioner
  annotations:
    description: "Pipeline for removing cluster configurations and disabling ArgoCD sync"
spec:
  description: >-
    Cluster removal pipeline that removes cluster from repository,
    commits the changes to GitHub, deletes ArgoCD ApplicationSets,
    and triggers bootstrap to reconcile changes.
  params:
    - name: cluster-name
      type: string
      description: "Name of the cluster to remove"
  tasks:
    - name: query-cluster-metadata
      taskSpec:
        params:
          - name: cluster-name
        results:
          - name: infra-id
            description: Infrastructure ID from ClusterDeployment
          - name: cluster-id
            description: Cluster ID from ClusterDeployment
          - name: region
            description: AWS region from ClusterDeployment
        steps:
          - name: query
            image: registry.redhat.io/openshift4/ose-cli
            script: |
              #!/bin/bash
              set -e
              
              echo "Querying ClusterDeployment metadata for: $(params.cluster-name)"
              
              INFRA_ID=$(oc get clusterdeployment -n "$(params.cluster-name)" "$(params.cluster-name)" \
                -o jsonpath='{.spec.clusterMetadata.infraID}' 2>/dev/null || \
                oc get clusterdeployment -n "$(params.cluster-name)" "$(params.cluster-name)" \
                -o jsonpath='{.status.infraID}' 2>/dev/null || echo "")
              
              CLUSTER_ID=$(oc get clusterdeployment -n "$(params.cluster-name)" "$(params.cluster-name)" \
                -o jsonpath='{.spec.clusterMetadata.clusterID}' 2>/dev/null || \
                oc get clusterdeployment -n "$(params.cluster-name)" "$(params.cluster-name)" \
                -o jsonpath='{.status.clusterID}' 2>/dev/null || echo "")
              
              REGION=$(oc get clusterdeployment -n "$(params.cluster-name)" "$(params.cluster-name)" \
                -o jsonpath='{.spec.platform.aws.region}' 2>/dev/null || echo "")
              
              if [ -z "$INFRA_ID" ]; then
                echo "Error: Could not find infraID for cluster $(params.cluster-name)" >&2
                exit 1
              fi
              
              echo "  Infra ID: $INFRA_ID"
              echo "  Cluster ID: ${CLUSTER_ID:-$INFRA_ID}"
              echo "  Region: $REGION"
              
              echo -n "$INFRA_ID" > $(results.infra-id.path)
              echo -n "${CLUSTER_ID:-$INFRA_ID}" > $(results.cluster-id.path)
              echo -n "$REGION" > $(results.region.path)
      params:
        - name: cluster-name
          value: "$(params.cluster-name)"
    
    - name: remove-from-repo-and-commit
      runAfter:
        - query-cluster-metadata
      taskSpec:
        params:
          - name: cluster-name
          - name: infra-id
          - name: cluster-id
          - name: region
        steps:
          - name: remove
            image: registry.redhat.io/openshift-pipelines/pipelines-git-init-rhel9@sha256:cbd89c531953a43b8055bda72f7696be80f57fd1d782567a91d82e0fbcb3d26d
            env:
              - name: SSH_PRIVATE_KEY
                valueFrom:
                  secretKeyRef:
                    name: github-repo-credentials
                    key: ssh-privatekey
            script: |
              #!/bin/bash
              set -e
              
              echo "üöÄ Starting cluster removal workflow..."
              echo "Cluster: $(params.cluster-name)"
              
              # Setup SSH directory and key
              SSH_DIR=/tekton/home/.ssh
              mkdir -p "$SSH_DIR"
              chmod 700 "$SSH_DIR"
              
              SSH_KEY_FILE="$SSH_DIR/id_rsa"
              echo "$SSH_PRIVATE_KEY" > "$SSH_KEY_FILE"
              chmod 600 "$SSH_KEY_FILE"
              
              # Add GitHub to known hosts
              ssh-keyscan github.com >> "$SSH_DIR/known_hosts" 2>/dev/null
              
              # Configure git identity
              export GIT_AUTHOR_NAME="Hub Provisioner Pipeline"
              export GIT_AUTHOR_EMAIL="hub-provisioner@bootstrap.red-chesterfield.com"
              export GIT_COMMITTER_NAME="Hub Provisioner Pipeline"
              export GIT_COMMITTER_EMAIL="hub-provisioner@bootstrap.red-chesterfield.com"
              
              echo "‚úÖ SSH key configured"
              
              # Clone repository
              echo "üì¶ Cloning repository..."
              WORK_DIR=$(mktemp -d)
              cd "$WORK_DIR"
              GIT_SSH_COMMAND="ssh -i $SSH_KEY_FILE -o StrictHostKeyChecking=no" \
                git clone git@github.com:openshift-online/bootstrap-hyperfleet.git .
              
              echo "üóëÔ∏è Running bin/cluster-remove..."
              INFRA_ID="$(params.infra-id)" CLUSTER_ID="$(params.cluster-id)" REGION="$(params.region)" \
                bash bin/cluster-remove "$(params.cluster-name)"
              
              # Commit and push changes
              echo "üìù Committing changes..."
              git add -A
              
              if git diff --cached --quiet; then
                echo "‚ÑπÔ∏è No changes to commit"
                exit 0
              fi
              
              git commit -m "Remove cluster $(params.cluster-name)" \
                -m "Automated cluster removal via pipeline" \
                -m "ü§ñ Generated with Claude Code" \
                -m "" \
                -m "Co-Authored-By: Claude <noreply@anthropic.com>"
              
              GIT_SSH_COMMAND="ssh -i $SSH_KEY_FILE -o StrictHostKeyChecking=no" \
                git push origin main
              
              echo "‚úÖ Changes committed and pushed to GitHub"
      params:
        - name: cluster-name
          value: "$(params.cluster-name)"
        - name: infra-id
          value: "$(tasks.query-cluster-metadata.results.infra-id)"
        - name: cluster-id
          value: "$(tasks.query-cluster-metadata.results.cluster-id)"
        - name: region
          value: "$(tasks.query-cluster-metadata.results.region)"
    
    - name: delete-applicationsets
      runAfter:
        - remove-from-repo-and-commit
      taskSpec:
        params:
          - name: cluster-name
        steps:
          - name: delete-appsets
            image: registry.redhat.io/openshift4/ose-cli
            script: |
              #!/bin/bash
              set -e
              
              echo "üóëÔ∏è Deleting ArgoCD ApplicationSets for: $(params.cluster-name)"
              
              # Delete provisioning ApplicationSet
              if oc get applicationset -n openshift-gitops "$(params.cluster-name)-provisioning" 2>/dev/null; then
                echo "Deleting $(params.cluster-name)-provisioning ApplicationSet..."
                oc delete applicationset -n openshift-gitops "$(params.cluster-name)-provisioning" --ignore-not-found=true
                echo "‚úÖ Deleted $(params.cluster-name)-provisioning"
              else
                echo "‚ÑπÔ∏è ApplicationSet $(params.cluster-name)-provisioning not found"
              fi
              
              # Delete content ApplicationSet
              if oc get applicationset -n openshift-gitops "$(params.cluster-name)-content" 2>/dev/null; then
                echo "Deleting $(params.cluster-name)-content ApplicationSet..."
                oc delete applicationset -n openshift-gitops "$(params.cluster-name)-content" --ignore-not-found=true
                echo "‚úÖ Deleted $(params.cluster-name)-content"
              else
                echo "‚ÑπÔ∏è ApplicationSet $(params.cluster-name)-content not found"
              fi
              
              echo "‚úÖ ApplicationSet deletion complete"
              echo "Note: Resources will be pruned automatically due to prune: true setting"
      params:
        - name: cluster-name
          value: "$(params.cluster-name)"

    - name: trigger-bootstrap
      runAfter:
        - delete-applicationsets
      taskSpec:
        steps:
          - name: trigger
            image: registry.redhat.io/openshift4/ose-cli
            script: |
              #!/bin/bash
              set -e
              
              echo "üöÄ Triggering bootstrap pipeline to reconcile changes..."
              
              # Create PipelineRun for bootstrap
              cat <<EOF | oc apply -f -
              apiVersion: tekton.dev/v1
              kind: PipelineRun
              metadata:
                generateName: bootstrap-post-removal-
                namespace: hub-provisioner
                labels:
                  tekton.dev/pipeline: bootstrap-pipeline
                  triggered-by: cluster-remove
              spec:
                pipelineRef:
                  name: bootstrap-pipeline
                timeout: 30m
              EOF
              
              echo "‚úÖ Bootstrap pipeline triggered"
  
  finally:
    - name: removal-summary
      taskSpec:
        params:
          - name: cluster-name
        steps:
          - name: summary
            image: registry.redhat.io/openshift4/ose-cli
            script: |
              #!/bin/bash
              
              echo "üìã Cluster Removal Summary"
              echo "=========================="
              echo "Cluster Name: $(params.cluster-name)"
              echo "Timestamp: $(date -Iseconds)"
              echo ""
              echo "‚úÖ Cluster removed from repository"
              echo "‚úÖ Changes committed to GitHub"
              echo "‚úÖ ApplicationSets deleted (resources will be pruned)"
              echo "‚úÖ Bootstrap pipeline triggered"
              echo ""
              echo "üìå Monitor:"
              echo "   1. Bootstrap pipeline execution"
              echo "   2. ManagedCluster and ClusterDeployment pruning"
              echo "   3. Namespace cleanup"
              echo "=========================="
      params:
        - name: cluster-name
          value: "$(params.cluster-name)"
