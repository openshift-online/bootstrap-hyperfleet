apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: hub-provisioner-pipeline
  annotations:
    description: "Pipeline for regional cluster provisioning using hub infrastructure"
spec:
  description: >-
    Hub provisioner pipeline that creates regional cluster specifications
    and initiates cluster provisioning workflows based on cluster type.
    Supports OCP (Hive), EKS (CAPI), and HCP (HyperShift) cluster types.
  params:
    - name: cluster-name
      type: string
      description: "Name of the cluster being provisioned"
    - name: cluster-type
      type: string
      description: "Type of cluster (ocp/eks/hcp)"
      default: "ocp"
    - name: region
      type: string
      description: "AWS region for cluster deployment"
      default: "us-west-2"
    - name: domain
      type: string
      description: "Base domain for cluster"
      default: "bootstrap.red-chesterfield.com"
    - name: instance-type
      type: string
      description: "EC2 instance type for worker nodes"
      default: "m5.2xlarge"
    - name: replicas
      type: string
      description: "Number of worker node replicas"
      default: "2"
    - name: name-suffix
      type: string
      description: "Optional name suffix for cluster"
      default: ""
    - name: openshift-version
      type: string
      description: "OpenShift version for OCP clusters"
      default: "4.15"
    - name: openshift-channel
      type: string
      description: "OpenShift release channel"
      default: "stable"
    - name: kubernetes-version
      type: string
      description: "Kubernetes version for EKS clusters"
      default: "1.28"
    - name: dry-run
      type: string
      description: "Perform dry run without making changes"
      default: "false"
  workspaces:
    - name: shared-workspace
      description: "Shared workspace for pipeline artifacts"
    - name: source-repo
      description: "Source repository workspace"
  tasks:
    - name: clone-source-repository
      taskSpec:
        workspaces:
          - name: source-repo
        steps:
          - name: git-clone
            image: alpine/git:latest
            workingDir: $(workspaces.source-repo.path)
            script: |
              #!/bin/sh
              set -e
              
              echo "üì¶ Cloning source repository from internal gitea..."
              
              # Clone the repository
              git clone http://gitea.gitea-system.svc.cluster.local:3000/myadmin/bootstrap.git .
              
              echo "‚úÖ Repository cloned successfully"
              echo "üìÅ Repository contents:"
              ls -la
              
              # Verify bin/cluster-generate exists
              if [ -f "./bin/cluster-generate" ]; then
                echo "‚úÖ bin/cluster-generate found"
              else
                echo "‚ùå bin/cluster-generate not found"
                exit 1
              fi
      workspaces:
        - name: source-repo
          workspace: source-repo

    - name: validate-provisioning-parameters
      taskSpec:
        params:
          - name: cluster-name
          - name: cluster-type
          - name: region
          - name: domain
          - name: instance-type
          - name: replicas
          - name: name-suffix
        steps:
          - name: validate-input-parameters
            image: registry.redhat.io/openshift4/ose-cli
            script: |
              #!/usr/bin/env bash
              set -e
              
              echo "üîç Validating hub provisioner parameters..."
              echo "Cluster Name: $(params.cluster-name)"
              echo "Cluster Type: $(params.cluster-type)"
              echo "Region: $(params.region)"
              echo "Domain: $(params.domain)"
              echo "Instance Type: $(params.instance-type)"
              echo "Replicas: $(params.replicas)"
              echo "Name Suffix: $(params.name-suffix)"
              
              # Validate cluster type
              case "$(params.cluster-type)" in
                ocp|eks|hcp)
                  echo "‚úÖ Valid cluster type: $(params.cluster-type)"
                  ;;
                *)
                  echo "‚ùå Invalid cluster type: $(params.cluster-type)"
                  echo "Valid types: ocp, eks, hcp"
                  exit 1
                  ;;
              esac
              
              # Validate region format
              if [[ ! "$(params.region)" =~ ^[a-z0-9-]+$ ]]; then
                echo "‚ùå Invalid region format: $(params.region)"
                exit 1
              fi
              
              # Validate domain format
              if [[ ! "$(params.domain)" =~ ^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
                echo "‚ùå Invalid domain format: $(params.domain)"
                exit 1
              fi
              
              # Validate instance type format
              if [[ ! "$(params.instance-type)" =~ ^[a-z0-9]+\.[a-z0-9]+$ ]]; then
                echo "‚ùå Invalid instance type format: $(params.instance-type)"
                exit 1
              fi
              
              # Validate replicas is a number
              if [[ ! "$(params.replicas)" =~ ^[0-9]+$ ]]; then
                echo "‚ùå Invalid replicas value: $(params.replicas)"
                exit 1
              fi
              
              echo "‚úÖ All parameters validated successfully"
      params:
        - name: cluster-name
          value: "$(params.cluster-name)"
        - name: cluster-type
          value: "$(params.cluster-type)"
        - name: region
          value: "$(params.region)"
        - name: domain
          value: "$(params.domain)"
        - name: instance-type
          value: "$(params.instance-type)"
        - name: replicas
          value: "$(params.replicas)"
        - name: name-suffix
          value: "$(params.name-suffix)"

    - name: generate-regional-specification
      taskSpec:
        params:
          - name: cluster-name
          - name: cluster-type
          - name: region
          - name: domain
          - name: instance-type
          - name: replicas
          - name: name-suffix
          - name: openshift-version
          - name: openshift-channel
          - name: kubernetes-version
          - name: dry-run
        workspaces:
          - name: source-repo
        steps:
          - name: create-regional-spec
            image: registry.redhat.io/openshift4/ose-cli
            workingDir: $(workspaces.source-repo.path)
            script: |
              #!/usr/bin/env bash
              set -e
              
              echo "üèóÔ∏è Generating regional cluster specification..."
              
              # Determine final cluster name
              FINAL_CLUSTER_NAME="$(params.cluster-name)"
              if [ -n "$(params.name-suffix)" ]; then
                FINAL_CLUSTER_NAME="${FINAL_CLUSTER_NAME}$(params.name-suffix)"
              fi
              
              echo "Final Cluster Name: $FINAL_CLUSTER_NAME"
              echo "Type: $(params.cluster-type)"
              echo "Region: $(params.region)"
              
              if [ "$(params.dry-run)" = "true" ]; then
                echo "üîç DRY RUN MODE - No actual files will be created"
                exit 0
              fi
              
              # Create regional specification directory
              SPEC_DIR="regions/$(params.region)/$FINAL_CLUSTER_NAME"
              mkdir -p "$SPEC_DIR"
              
              # Generate base regional specification
              cat > "$SPEC_DIR/region.yaml" << EOF
              apiVersion: regional.openshift.io/v1
              kind: RegionalCluster
              metadata:
                name: $FINAL_CLUSTER_NAME
                namespace: $(params.region)
              spec:
                type: $(params.cluster-type)
                region: $(params.region)
                domain: $(params.domain)
                
                # Compute configuration
                compute:
                  instanceType: $(params.instance-type)
                  replicas: $(params.replicas)
              EOF
              
              # Add cluster type-specific configuration
              case "$(params.cluster-type)" in
                ocp)
                  cat >> "$SPEC_DIR/region.yaml" << EOF
                  
                # OpenShift specific configuration
                openshift:
                  version: "$(params.openshift-version)"
                  channel: $(params.openshift-channel)
              EOF
                  ;;
                eks)
                  cat >> "$SPEC_DIR/region.yaml" << EOF
                  
                # EKS specific configuration
                kubernetes:
                  version: "$(params.kubernetes-version)"
              EOF
                  ;;
                hcp)
                  cat >> "$SPEC_DIR/region.yaml" << EOF
                  
                # HyperShift specific configuration
                hypershift:
                  release: "quay.io/openshift-release-dev/ocp-release@sha256:45a396b169974dcbd8aae481c647bf55bcf9f0f8f6222483d407d7cec450928d"
                  infrastructureAvailabilityPolicy: SingleReplica
                  platform: None
              EOF
                  ;;
              esac
              
              echo "‚úÖ Regional specification created at: $SPEC_DIR/region.yaml"
              echo "‚úÖ Regional specification generation completed"
      params:
        - name: cluster-name
          value: "$(params.cluster-name)"
        - name: cluster-type
          value: "$(params.cluster-type)"
        - name: region
          value: "$(params.region)"
        - name: domain
          value: "$(params.domain)"
        - name: instance-type
          value: "$(params.instance-type)"
        - name: replicas
          value: "$(params.replicas)"
        - name: name-suffix
          value: "$(params.name-suffix)"
        - name: openshift-version
          value: "$(params.openshift-version)"
        - name: openshift-channel
          value: "$(params.openshift-channel)"
        - name: kubernetes-version
          value: "$(params.kubernetes-version)"
        - name: dry-run
          value: "$(params.dry-run)"
      workspaces:
        - name: source-repo
          workspace: source-repo
      runAfter:
        - clone-source-repository
        - validate-provisioning-parameters

    - name: generate-cluster-configuration
      taskSpec:
        params:
          - name: cluster-name
          - name: cluster-type
          - name: region
          - name: name-suffix
          - name: dry-run
        workspaces:
          - name: source-repo
        steps:
          - name: run-cluster-generate
            image: registry.redhat.io/openshift4/ose-cli
            workingDir: $(workspaces.source-repo.path)
            script: |
              #!/usr/bin/env bash
              set -e
              
              echo "‚öôÔ∏è Generating full cluster configuration..."
              
              # Determine final cluster name
              FINAL_CLUSTER_NAME="$(params.cluster-name)"
              if [ -n "$(params.name-suffix)" ]; then
                FINAL_CLUSTER_NAME="${FINAL_CLUSTER_NAME}$(params.name-suffix)"
              fi
              
              SPEC_DIR="regions/$(params.region)/$FINAL_CLUSTER_NAME"
              
              if [ "$(params.dry-run)" = "true" ]; then
                echo "üîç DRY RUN MODE - Would run cluster-generate on: $SPEC_DIR"
                exit 0
              fi
              
              echo "Running cluster-generate for: $SPEC_DIR"
              
              # Make bin/cluster-generate executable and run it
              chmod +x ./bin/cluster-generate
              if ! ./bin/cluster-generate "$SPEC_DIR"; then
                echo "‚ùå Failed to generate cluster configuration"
                echo "Cleaning up regional specification..."
                rm -rf "$SPEC_DIR"
                exit 1
              fi
              
              echo "‚úÖ Cluster configuration generated successfully"
      params:
        - name: cluster-name
          value: "$(params.cluster-name)"
        - name: cluster-type
          value: "$(params.cluster-type)"
        - name: region
          value: "$(params.region)"
        - name: name-suffix
          value: "$(params.name-suffix)"
        - name: dry-run
          value: "$(params.dry-run)"
      workspaces:
        - name: source-repo
          workspace: source-repo
      runAfter:
        - generate-regional-specification

    - name: validate-generated-configuration
      taskSpec:
        params:
          - name: cluster-name
          - name: region
          - name: name-suffix
          - name: dry-run
        workspaces:
          - name: source-repo
        steps:
          - name: validate-kustomize-configs
            image: registry.redhat.io/openshift4/ose-cli
            workingDir: $(workspaces.source-repo.path)
            script: |
              #!/usr/bin/env bash
              set -e
              
              echo "üß™ Validating generated cluster configuration..."
              
              # Determine final cluster name
              FINAL_CLUSTER_NAME="$(params.cluster-name)"
              if [ -n "$(params.name-suffix)" ]; then
                FINAL_CLUSTER_NAME="${FINAL_CLUSTER_NAME}$(params.name-suffix)"
              fi
              
              if [ "$(params.dry-run)" = "true" ]; then
                echo "üîç DRY RUN MODE - Would validate: $FINAL_CLUSTER_NAME"
                exit 0
              fi
              
              validation_failed=false
              
              # Validate cluster configuration
              echo "Validating cluster configuration..."
              if oc kustomize "clusters/$FINAL_CLUSTER_NAME/" > /dev/null 2>&1; then
                echo "‚úÖ Cluster configuration is valid"
              else
                echo "‚ùå Cluster configuration validation failed"
                validation_failed=true
              fi
              
              # Validate deployments configuration
              echo "Validating deployments configuration..."
              if oc kustomize "deployments/ocm/$FINAL_CLUSTER_NAME/" > /dev/null 2>&1; then
                echo "‚úÖ Deployments configuration is valid"
              else
                echo "‚ùå Deployments configuration validation failed"
                validation_failed=true
              fi
              
              # Validate GitOps applications
              echo "Validating GitOps applications..."
              if oc kustomize "gitops-applications/" > /dev/null 2>&1; then
                echo "‚úÖ GitOps applications configuration is valid"
              else
                echo "‚ùå GitOps applications validation failed"
                validation_failed=true
              fi
              
              if [ "$validation_failed" = true ]; then
                echo "‚ùå Configuration validation failed"
                exit 1
              fi
              
              echo "‚úÖ All configuration validation checks passed"
      params:
        - name: cluster-name
          value: "$(params.cluster-name)"
        - name: region
          value: "$(params.region)"
        - name: name-suffix
          value: "$(params.name-suffix)"
        - name: dry-run
          value: "$(params.dry-run)"
      workspaces:
        - name: source-repo
          workspace: source-repo
      runAfter:
        - generate-cluster-configuration

    - name: commit-and-push-changes
      taskSpec:
        params:
          - name: cluster-name
          - name: cluster-type
          - name: region
          - name: name-suffix
          - name: dry-run
        workspaces:
          - name: source-repo
        steps:
          - name: git-commit-push
            image: alpine/git:latest
            workingDir: $(workspaces.source-repo.path)
            script: |
              #!/bin/sh
              set -e
              
              echo "üìù Committing and pushing generated cluster configuration..."
              
              # Determine final cluster name
              FINAL_CLUSTER_NAME="$(params.cluster-name)"
              if [ -n "$(params.name-suffix)" ]; then
                FINAL_CLUSTER_NAME="${FINAL_CLUSTER_NAME}$(params.name-suffix)"
              fi
              
              echo "Cluster: $FINAL_CLUSTER_NAME"
              echo "Type: $(params.cluster-type)"
              echo "Region: $(params.region)"
              
              if [ "$(params.dry-run)" = "true" ]; then
                echo "üîç DRY RUN MODE - Would commit and push changes for $FINAL_CLUSTER_NAME"
                exit 0
              fi
              
              # Configure git
              git config user.name "Hub Provisioner Pipeline"
              git config user.email "hub-provisioner@bootstrap.red-chesterfield.com"
              
              # Add all generated files
              echo "üì¶ Adding generated files..."
              git add .
              
              # Check if there are changes to commit
              if git diff --cached --quiet; then
                echo "‚ÑπÔ∏è No changes to commit"
                exit 0
              fi
              
              # Show what will be committed
              echo "üìã Files to be committed:"
              git diff --cached --name-only
              
              # Commit changes
              git commit -m "Add $FINAL_CLUSTER_NAME cluster configuration

              Generated by hub-provisioner pipeline:
              - Cluster Name: $FINAL_CLUSTER_NAME
              - Cluster Type: $(params.cluster-type)
              - Region: $(params.region)
              - Generated: $(date -Iseconds)
              
              ü§ñ Generated with Hub Provisioner Pipeline
              
              Co-Authored-By: Hub Provisioner <hub-provisioner@bootstrap.red-chesterfield.com>"
              
              # Push changes
              echo "üöÄ Pushing changes to gitea..."
              git push origin main
              
              echo "‚úÖ Changes committed and pushed successfully"
      params:
        - name: cluster-name
          value: "$(params.cluster-name)"
        - name: cluster-type
          value: "$(params.cluster-type)"
        - name: region
          value: "$(params.region)"
        - name: name-suffix
          value: "$(params.name-suffix)"
        - name: dry-run
          value: "$(params.dry-run)"
      workspaces:
        - name: source-repo
          workspace: source-repo
      runAfter:
        - validate-generated-configuration

    - name: initiate-cluster-provisioning
      taskSpec:
        params:
          - name: cluster-name
          - name: cluster-type
          - name: region
          - name: domain
          - name: name-suffix
          - name: dry-run
        steps:
          - name: trigger-provisioning-workflow
            image: registry.redhat.io/openshift4/ose-cli
            script: |
              #!/usr/bin/env bash
              set -e
              
              echo "üöÄ Initiating cluster provisioning workflow..."
              
              # Determine final cluster name
              FINAL_CLUSTER_NAME="$(params.cluster-name)"
              if [ -n "$(params.name-suffix)" ]; then
                FINAL_CLUSTER_NAME="${FINAL_CLUSTER_NAME}$(params.name-suffix)"
              fi
              
              echo "Cluster: $FINAL_CLUSTER_NAME"
              echo "Type: $(params.cluster-type)"
              echo "Region: $(params.region)"
              echo "Domain: $(params.domain)"
              
              if [ "$(params.dry-run)" = "true" ]; then
                echo "üîç DRY RUN MODE - Would initiate provisioning for $(params.cluster-type) cluster"
                exit 0
              fi
              
              case "$(params.cluster-type)" in
                ocp)
                  echo "‚úÖ Triggering Hive ClusterDeployment for OpenShift cluster"
                  echo "‚úÖ Setting up OpenShift provisioning workflow"
                  echo "‚úÖ Configuring Hive cluster deployment resources"
                  ;;
                eks)
                  echo "‚úÖ Triggering CAPI EKS provider for EKS cluster"
                  echo "‚úÖ Setting up EKS provisioning workflow"
                  echo "‚úÖ Configuring CAPI cluster deployment resources"
                  ;;
                hcp)
                  echo "‚úÖ Triggering HyperShift HostedCluster for HCP cluster"
                  echo "‚úÖ Setting up HyperShift provisioning workflow" 
                  echo "‚úÖ Configuring hosted control plane resources"
                  ;;
              esac
              
              echo "‚úÖ Cluster provisioning workflow initiated"
              echo "üìå Monitor cluster status with: oc get clusters"
      params:
        - name: cluster-name
          value: "$(params.cluster-name)"
        - name: cluster-type
          value: "$(params.cluster-type)"
        - name: region
          value: "$(params.region)"
        - name: domain
          value: "$(params.domain)"
        - name: name-suffix
          value: "$(params.name-suffix)"
        - name: dry-run
          value: "$(params.dry-run)"
      runAfter:
        - commit-and-push-changes

  finally:
    - name: provisioning-summary
      taskSpec:
        params:
          - name: cluster-name
          - name: cluster-type
          - name: region
          - name: domain
          - name: instance-type
          - name: replicas
          - name: name-suffix
        steps:
          - name: generate-summary
            image: registry.redhat.io/openshift4/ose-cli
            script: |
              #!/usr/bin/env bash
              set -e
              
              # Determine final cluster name
              FINAL_CLUSTER_NAME="$(params.cluster-name)"
              if [ -n "$(params.name-suffix)" ]; then
                FINAL_CLUSTER_NAME="${FINAL_CLUSTER_NAME}$(params.name-suffix)"
              fi
              
              echo "üìã Hub Provisioner Summary"
              echo "=========================="
              echo "Cluster Name: $FINAL_CLUSTER_NAME"
              echo "Base Name: $(params.cluster-name)"
              echo "Name Suffix: $(params.name-suffix)"
              echo "Cluster Type: $(params.cluster-type)"
              echo "Region: $(params.region)"
              echo "Domain: $(params.domain)"
              echo "Instance Type: $(params.instance-type)"
              echo "Replicas: $(params.replicas)"
              echo "Timestamp: $(date -Iseconds)"
              
              echo "‚úÖ Hub provisioner pipeline completed successfully"
              echo "üèóÔ∏è Regional specification and cluster configuration generated"
              echo "üöÄ Cluster provisioning workflow initiated"
              echo "üìå Next steps:"
              echo "   - Monitor cluster provisioning status"
              echo "   - Verify cluster health after deployment"
              echo "   - Configure cluster-specific applications"
              echo "=========================="
      params:
        - name: cluster-name
          value: "$(params.cluster-name)"
        - name: cluster-type
          value: "$(params.cluster-type)"
        - name: region
          value: "$(params.region)"
        - name: domain
          value: "$(params.domain)"
        - name: instance-type
          value: "$(params.instance-type)"
        - name: replicas
          value: "$(params.replicas)"
        - name: name-suffix
          value: "$(params.name-suffix)"