#!/bin/bash
set -e

# Script for removing cluster configurations from repository
# Designed to be invoked by Tekton pipeline with cluster name parameter
# Usage: cluster-remove CLUSTER_NAME

echo "OpenShift Regional Cluster Removal Tool"
echo "======================================="
echo ""

# Get cluster name from first argument
CLUSTER_NAME="$1"

if [ -z "$CLUSTER_NAME" ]; then
    echo "Error: Cluster name is required" >&2
    echo "Usage: $0 CLUSTER_NAME" >&2
    exit 1
fi

echo "Removing cluster: $CLUSTER_NAME"

# Validate cluster directory exists
if [ ! -d "clusters/$CLUSTER_NAME" ]; then
    echo "Error: Cluster directory not found: clusters/$CLUSTER_NAME" >&2
    exit 1
fi

echo "Removing cluster directory: clusters/$CLUSTER_NAME"
git rm -r "clusters/$CLUSTER_NAME"

echo "Updating clusters/global/gitops/kustomization.yaml"
GITOPS_KUSTOMIZATION="clusters/global/gitops/kustomization.yaml"

if [ -f "$GITOPS_KUSTOMIZATION" ]; then
    # Remove the cluster gitops reference line
    sed -i "/- \.\.\/.\.\/.*$CLUSTER_NAME\/gitops\//d" "$GITOPS_KUSTOMIZATION"
    
    # Stage the kustomization file change
    git add "$GITOPS_KUSTOMIZATION"
    
    echo "Updated $GITOPS_KUSTOMIZATION"
else
    echo "Warning: $GITOPS_KUSTOMIZATION not found" >&2
fi

echo "Cluster removal complete"