#!/bin/bash
set -e

# Script to remove cluster directory from repository and trigger bootstrap
# Called by cluster-remove-pipeline after ClusterDeprovision completes
# Usage: cluster-remove CLUSTER_NAME

echo "OpenShift Cluster Repository Cleanup Tool"
echo "=========================================="
echo ""

CLUSTER_NAME="$1"

if [ -z "$CLUSTER_NAME" ]; then
    echo "Error: Cluster name is required" >&2
    echo "Usage: $0 CLUSTER_NAME" >&2
    exit 1
fi

echo "Cluster: $CLUSTER_NAME"

CLUSTER_DIR="clusters/$CLUSTER_NAME"

if [ ! -d "$CLUSTER_DIR" ]; then
    echo "Warning: Cluster directory not found: $CLUSTER_DIR" >&2
    echo "Cluster may have already been removed"
    exit 0
fi

echo ""
echo "Removing cluster from repository..."

rm -rf "$CLUSTER_DIR"
echo "  ✅ Removed directory: $CLUSTER_DIR"

echo ""
echo "Updating global GitOps configuration..."

GITOPS_KUSTOMIZATION="clusters/global/gitops/kustomization.yaml"

if grep -q "\- \.\./\.\./[^/]*/${CLUSTER_NAME}/" "$GITOPS_KUSTOMIZATION" 2>/dev/null; then
    sed -i "/\- \.\./\.\./[^/]*\/${CLUSTER_NAME}\//d" "$GITOPS_KUSTOMIZATION"
    echo "  ✅ Removed references from $GITOPS_KUSTOMIZATION"
else
    echo "  ℹ️  No references found in $GITOPS_KUSTOMIZATION"
fi

CLUSTERS_KUSTOMIZATION="clusters/kustomization.yaml"

if grep -q "\- ${CLUSTER_NAME}/" "$CLUSTERS_KUSTOMIZATION" 2>/dev/null; then
    sed -i "/\- ${CLUSTER_NAME}\//d" "$CLUSTERS_KUSTOMIZATION"
    echo "  ✅ Removed reference from $CLUSTERS_KUSTOMIZATION"
else
    echo "  ℹ️  No reference found in $CLUSTERS_KUSTOMIZATION"
fi

git add -A

echo ""
echo "=========================================="
echo "Cluster repository cleanup complete!"
echo ""
echo "Removed cluster: $CLUSTER_NAME"
echo ""
echo "Next step:"
echo "  Trigger bootstrap pipeline to reconcile changes"
echo "=========================================="
